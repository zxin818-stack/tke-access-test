apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "job-env.fullname" . }}
  labels:
    {{- include "job-env.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "{{ .Values.job.hookWeight }}"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 3
  template:
    metadata:
      name: {{ include "job-env.fullname" . }}
      labels:
        {{- include "job-env.selectorLabels" . | nindent 8 }}
    spec:
      serviceAccountName: {{ include "job-env.fullname" . }}-sa
      restartPolicy: OnFailure
      containers:
        - name: detect-cluster
          image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - sh
            - -c
            - |
              set -e
              
              echo "=========================================="
              echo "开始检测集群环境..."
              echo "=========================================="
              
              # 获取所有节点的 labels（JSON 格式）
              echo "正在获取节点 labels..."
              NODE_LABELS=$(kubectl get nodes -o json | jq -r '.items[].metadata.labels | to_entries[] | .key')
              
              echo "节点 labels:"
              echo "$NODE_LABELS"
              echo ""
              
              # 检查是否包含 "tke.cloud.tencent" 字符串（模糊匹配）
              if echo "$NODE_LABELS" | grep -q "tke.cloud.tencent"; then
                CLUSTER_TYPE="tke"
                echo "✅ 检测到包含 'tke.cloud.tencent' 的 label"
              else
                CLUSTER_TYPE="unknown"
                echo "❌ 未检测到包含 'tke.cloud.tencent' 的 label"
              fi
              
              echo "集群类型: $CLUSTER_TYPE"
              echo ""
              
              # 检查 ConfigMap 是否已存在
              if kubectl get configmap {{ .Values.configmap.name }} -n {{ .Release.Namespace }} >/dev/null 2>&1; then
                echo "ConfigMap 已存在，正在更新..."
                kubectl create configmap {{ .Values.configmap.name }} \
                  --from-literal=clusterType=$CLUSTER_TYPE \
                  --from-literal=detectionLabel={{ .Values.detection.labelPattern }} \
                  --dry-run=client -o yaml | kubectl apply -f -
              else
                echo "ConfigMap 不存在，正在创建..."
                kubectl create configmap {{ .Values.configmap.name }} \
                  --from-literal=clusterType=$CLUSTER_TYPE \
                  --from-literal=detectionLabel={{ .Values.detection.labelPattern }} \
                  -n {{ .Release.Namespace }}
              fi
              
              echo ""
              echo "=========================================="
              echo "✅ 集群环境检测完成！"
              echo "=========================================="
              echo "ConfigMap: {{ .Values.configmap.name }}"
              echo "Namespace: {{ .Release.Namespace }}"
              echo "ClusterType: $CLUSTER_TYPE"
              echo "=========================================="
              
              # 显示 ConfigMap 内容
              echo ""
              echo "ConfigMap 内容:"
              kubectl get configmap {{ .Values.configmap.name }} -n {{ .Release.Namespace }} -o yaml
